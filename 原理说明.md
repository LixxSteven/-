# 视频合并转换工具 - 原理说明

本程序旨在自动化处理包含 `.m3u8` 播放列表的视频文件夹，将分散的视频片段合并并转换为单个 `.mp4` 文件。

##核心流程：

1.  **用户界面 (UI)**:
    *   使用 `tkinter`库构建图形用户界面，方便用户选择输入和输出文件夹，并查看处理进度和历史记录。
    *   主要 UI 组件包括：
        *   输入/输出文件夹选择框和浏览按钮。
        *   “开始合并与转换”按钮。
        *   进度条和状态标签，实时显示处理状态。
        *   历史记录列表，展示过往的转换任务及其结果。

2.  **输入处理**:
    *   程序启动后，用户通过 UI 指定一个“输入文件夹”。
    *   点击“开始”按钮后，程序会遍历指定的“输入文件夹”下的所有直接子文件夹。
    *   对于每一个子文件夹，程序会查找是否存在以 `.m3u8` 为扩展名的文件。`.m3u8` 文件通常用于 HLS (HTTP Live Streaming) 协议，它是一个播放列表，指向一系列小的视频片段（通常是 `.ts` 文件）。

3.  **FFmpeg 调用**:
    *   如果在一个子文件夹中找到了 `.m3u8` 文件，程序将使用 `subprocess` 模块调用外部程序 FFmpeg 来执行合并和转换操作。
    *   FFmpeg 是一个强大的多媒体处理工具集，能够处理各种音视频格式。
    *   构造的 FFmpeg 命令大致如下：
        ```
        ffmpeg -protocol_whitelist file,http,https,tcp,tls,crypto,pipe -i "path/to/input.m3u8" -c copy -bsf:a aac_adtstoasc "path/to/output.mp4"
        ```
        *   `-protocol_whitelist ...`: 允许 FFmpeg 通过指定协议访问本地文件或网络资源。 `pipe` 被加入以支持更广泛的输入源。
        *   `-i "path/to/input.m3u8"`: 指定输入的 `.m3u8` 文件路径。
        *   `-c copy`: 参数指示 FFmpeg 尝试直接复制视频流和音频流，而不进行重新编码。这通常是最快的方式，因为它避免了耗时的编码过程。前提是原始视频片段的编码与目标 MP4 容器兼容。
        *   `-bsf:a aac_adtstoasc`: 这是一个比特流过滤器，用于处理 AAC 音频流。当从 TS (Transport Stream) 格式（常见于 HLS 片段）转换为 MP4 时，有时需要此过滤器来确保 AAC 音频的正确封装。
        *   `"path/to/output.mp4"`: 指定输出的 `.mp4` 文件路径和名称。输出文件名通常根据其原始子文件夹的名称生成。
        *   `-y`: (在脚本中添加) 如果输出文件已存在，则自动覆盖，不提示用户。

4.  **输出处理**:
    *   转换后的 `.mp4` 文件会保存在用户通过 UI 指定的“输出文件夹”中。
    *   程序会自动处理输出文件名的冲突。如果目标输出文件夹中已存在同名文件，它会在新文件名后追加一个数字（例如 `video_1.mp4`, `video_2.mp4`）以确保唯一性。

5.  **多线程处理**:
    *   为了防止在处理大量视频或耗时较长的转换任务时 UI 卡死，实际的视频处理逻辑（包括 FFmpeg 调用）在一个单独的线程 (`threading.Thread`) 中执行。
    *   这样主 UI 线程可以保持响应，用户仍然可以与界面交互。
    *   线程与主 UI 线程之间的通信（例如更新进度条、显示消息）通过 `root.after()` 方法安全地进行，这是 Tkinter 中推荐的跨线程 UI 更新方式。

6.  **进度与状态更新**:
    *   在处理过程中，UI 上的进度条会根据已处理的子文件夹数量进行更新。
    *   状态标签会显示当前正在处理的文件夹名称或总体状态（如“空闲”、“准备中”、“处理完成”）。

7.  **历史记录**:
    *   每次转换操作（无论成功或失败）的相关信息（时间戳、输入路径、输出文件、状态）都会被记录下来。
    *   这些记录会显示在 UI 的历史记录列表中，并持久化存储在一个名为 `conversion_history.json` 的 JSON 文件中。该文件位于程序脚本所在的目录。
    *   用户可以清空历史记录。

8.  **错误处理**:
    *   程序会捕获常见的错误，例如：
        *   输入/输出文件夹路径无效。
        *   未找到 FFmpeg 执行文件 (会提示用户检查 FFmpeg 安装和路径配置)。
        *   FFmpeg 执行转换时发生错误 (会将 FFmpeg 的错误输出显示给用户)。
        *   其他意外异常。
    *   错误信息会通过消息框 (`messagebox`) 显示给用户，并记录到历史记录中。

## 关键技术点：

*   **Tkinter**: 用于构建图形用户界面。
*   **os**: 用于文件和目录操作，如路径拼接、检查文件/文件夹是否存在、列出目录内容等。
*   **subprocess**: 用于启动和管理外部进程，主要是 FFmpeg。
*   **threading**: 用于实现多线程，避免 UI 阻塞。
*   **json**: 用于读取和写入历史记录文件 (`conversion_history.json`)。
*   **datetime**: 用于生成历史记录中的时间戳。
*   **FFmpeg**: 核心的视频处理引擎，本程序依赖其命令行接口。

## 注意事项：

*   **FFmpeg 依赖**: 程序正确运行的前提是系统中正确安装了 FFmpeg，并且其路径已配置在系统 PATH 环境变量中，或者在脚本的 `self.ffmpeg_path` 变量中明确指定了 `ffmpeg.exe` 的完整路径。
*   **输入文件结构**: 程序期望输入文件夹的直接子文件夹中包含 `.m3u8` 文件。如果结构不符，可能无法正确处理视频。